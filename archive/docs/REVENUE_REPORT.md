# –û—Ç—á–µ—Ç –ø–æ –≤—ã—Ä—É—á–∫–µ –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Ä—É—á–∫–∏ –ø–æ —Ç–∏–ø–∞–º (–±–∞—Ä, –∫—É—Ö–Ω—è, –¥–æ—Å—Ç–∞–≤–∫–∞) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å–∞.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏

1. **db/settings_db.py** - —Ä–∞–±–æ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ –ë–î
   - `get_yandex_commission()` - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å–∞
   - `set_yandex_commission(percent)` - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏
   - `init_settings_table()` - —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫

2. **services/revenue_report.py** - –ª–æ–≥–∏–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—ã—Ä—É—á–∫–µ
   - `get_revenue_report(date_from, date_to)` - –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ iiko
   - `calculate_revenue(data)` - —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—ã—Ä—É—á–∫—É –ø–æ —Ç–∏–ø–∞–º
   - `format_revenue_report(revenue_data, date_from, date_to)` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç

3. **handlers/yandex_commission_settings.py** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
   - –ö–Ω–æ–ø–∫–∞: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å"
   - FSM –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª—è—Ö

1. **handlers/sales_olap_console.py**
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ –∫–Ω–æ–ø–∫—É "üìà –í—ã—Ä—É—á–∫–∞ / –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"
   - –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–π –∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –∏–∑ iiko

2. **keyboards/main_keyboard.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_commission_settings_keyboard()`
   - –î–æ–±–∞–≤–ª–µ–Ω handler –¥–ª—è –∫–Ω–æ–ø–∫–∏ "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–π"

3. **main.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `init_settings_table()` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞

4. **bot.py**
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–æ—É—Ç–µ—Ä `yandex_commission_settings.router`

## –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–û—Ç—á–µ—Ç –∏–∑ iiko (ID: `3646ed72-6eee-4085-9179-4f7e88fa1cac`) —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `CookingPlaceType` - —Ç–∏–ø –º–µ—Å—Ç–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–ë–∞—Ä, –ö—É—Ö–Ω—è, –ü–∏—Ü—Ü–∞ –∏ —Ç.–¥.)
- `PayTypes` - —Ç–∏–ø –æ–ø–ª–∞—Ç—ã (–ù–∞–ª–∏—á–Ω—ã–µ, –Ø–Ω–¥–µ–∫—Å.–æ–ø–ª–∞—Ç–∞ –∏ —Ç.–¥.)
- `DishSumInt` - —Å—É–º–º–∞ –ë–ï–ó —Å–∫–∏–¥–∫–∏
- `DishDiscountSumInt` - —Å—É–º–º–∞ –°–û —Å–∫–∏–¥–∫–æ–π

### –†–∞—Å—á–µ—Ç –≤—ã—Ä—É—á–∫–∏

1. **–í—ã—Ä—É—á–∫–∞ –±–∞—Ä–∞**
   - –§–∏–ª—å—Ç—Ä: `CookingPlaceType == "–ë–∞—Ä"` AND `PayTypes != "–Ø–Ω–¥–µ–∫—Å.–æ–ø–ª–∞—Ç–∞"`
   - –ü–æ–ª–µ: `DishDiscountSumInt` (—Å—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π)

2. **–í—ã—Ä—É—á–∫–∞ –∫—É—Ö–Ω–∏**
   - –§–∏–ª—å—Ç—Ä: `CookingPlaceType IN ["–ö—É—Ö–Ω—è", "–ö—É—Ö–Ω—è-–ü–∏—Ü—Ü–∞", "–ü–∏—Ü—Ü–∞"]` AND `PayTypes != "–Ø–Ω–¥–µ–∫—Å.–æ–ø–ª–∞—Ç–∞"`
   - –ü–æ–ª–µ: `DishDiscountSumInt` (—Å—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π)

3. **–í—ã—Ä—É—á–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ø–Ω–¥–µ–∫—Å)**
   - –§–∏–ª—å—Ç—Ä: `PayTypes == "–Ø–Ω–¥–µ–∫—Å.–æ–ø–ª–∞—Ç–∞"`
   - –ü–æ–ª–µ: `DishSumInt` (—Å—É–º–º–∞ –ë–ï–ó —Å–∫–∏–¥–∫–∏)
   - –†–∞—Å—á–µ—Ç: `DishSumInt - (DishSumInt √ó –∫–æ–º–∏—Å—Å–∏—è_—è–Ω–¥–µ–∫—Å–∞ / 100)`

### –ü—Ä–∏–º–µ—Ä

```
–°—É–º–º–∞ –Ø–Ω–¥–µ–∫—Å.–æ–ø–ª–∞—Ç—ã: 100 000 ‚ÇΩ
–ö–æ–º–∏—Å—Å–∏—è –Ø–Ω–¥–µ–∫—Å–∞: 25%
–ö–æ–º–∏—Å—Å–∏—è –≤ —Ä—É–±–ª—è—Ö: 100 000 √ó 0.25 = 25 000 ‚ÇΩ
–í—ã—Ä—É—á–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: 100 000 - 25 000 = 75 000 ‚ÇΩ
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å–∞

1. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üìä –û—Ç—á—ë—Ç—ã"
2. –í—ã–±—Ä–∞—Ç—å "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–π"
3. –í—ã–±—Ä–∞—Ç—å "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å"
4. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.5)
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞

1. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üìä –û—Ç—á—ë—Ç—ã"
2. –í—ã–±—Ä–∞—Ç—å "üìà –í—ã—Ä—É—á–∫–∞ / –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"
3. –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞
4. –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
5. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç

### –§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞

```
üí∞ –û–¢–ß–ï–¢ –ü–û –í–´–†–£–ß–ö–ï
–ü–µ—Ä–∏–æ–¥: 01.11.2024 - 30.11.2024

üçπ –ë–ê–†
  –í—ã—Ä—É—á–∫–∞: 450 000.00 ‚ÇΩ

üçï –ö–£–•–ù–Ø (–ö—É—Ö–Ω—è + –ü–∏—Ü—Ü–∞)
  –í—ã—Ä—É—á–∫–∞: 1 200 000.00 ‚ÇΩ

üöó –î–û–°–¢–ê–í–ö–ê (–Ø–Ω–¥–µ–∫—Å)
  –í—ã—Ä—É—á–∫–∞ –¥–æ –≤—ã—á–µ—Ç–∞: 800 000.00 ‚ÇΩ
  –ö–æ–º–∏—Å—Å–∏—è (25%): -200 000.00 ‚ÇΩ
  –í—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞: 600 000.00 ‚ÇΩ

üíµ –ò–¢–û–ì–û
  –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: 2 250 000.00 ‚ÇΩ
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ settings

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
)
```

–ö–ª—é—á –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å–∞: `yandex_commission`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
python test_revenue_report.py
```

–°–∫—Ä–∏–ø—Ç:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–∏—Å—Å–∏—é (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
3. –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç—á–µ—Ç –∑–∞ –Ω–æ—è–±—Ä—å 2024
4. –í—ã–≤–æ–¥–∏—Ç —Ä–∞—Å—á–µ—Ç—ã

## TODO / –í–æ–ø—Ä–æ—Å—ã

- [ ] –£—Ç–æ—á–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç "–≤—ã—Ä—É—á–∫–∏ —Ä–∞—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö" (—É–ø–æ–º—è–Ω—É—Ç–æ –≤ –¢–ó, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –æ—Ç—á–µ—Ç (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
