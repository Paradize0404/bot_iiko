# Архитектура системы истории должностей

## Поток данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            iiko API                                      │
│  /resto/api/employees + /resto/api/employees/roles                      │
└───────────────────────────┬─────────────────────────────────────────────┘
                            │
                            │ Каждые 24 часа
                            ↓
                ┌───────────────────────────┐
                │  position_monitor.py      │
                │  - Получает всех сотр.    │
                │  - Сравнивает с БД        │
                │  - Фиксирует изменения    │
                └─────────┬─────────────────┘
                          │
                          ↓
        ┌─────────────────────────────────────┐
        │  employee_position_history          │
        │  ┌───────────────────────────────┐  │
        │  │ id | emp_id | position_name   │  │
        │  │ valid_from | valid_to         │  │
        │  └───────────────────────────────┘  │
        └──────────┬──────────────────────────┘
                   │
                   │ Запрос при расчете
                   ↓
    ┌──────────────────────────────────────────┐
    │   salary_from_iiko.py                    │
    │   1. Получить attendance за период       │
    │   2. Для каждого сотрудника:             │
    │      - Получить историю должностей       │
    │      - Разделить attendance по периодам  │
    │      - Применить настройки должности     │
    │      - Суммировать результаты            │
    └──────────────────────────────────────────┘
```

## Компоненты системы

### Хранилище данных

```
┌────────────────────────────────────────────────────────────┐
│                    PostgreSQL                               │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  position_commissions                                       │
│  ┌────────────────────────────────────────────────────┐    │
│  │ position_name | payment_type | fixed_rate          │    │
│  │ commission_type | commission_percent               │    │
│  └────────────────────────────────────────────────────┘    │
│                                                             │
│  employee_position_history                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │ employee_id | position_name | valid_from | valid_to│    │
│  └────────────────────────────────────────────────────┘    │
│                                                             │
└────────────────────────────────────────────────────────────┘
```

### Обработчики (Handlers)

```
┌─────────────────────────────────────────────────────┐
│  /correct_position                                   │
│  ┌───────────────────────────────────────────────┐  │
│  │ 1. Выбор сотрудника                           │  │
│  │ 2. Показ истории (90 дней)                    │  │
│  │ 3. Ввод даты                                  │  │
│  │ 4. Выбор должности                            │  │
│  │ 5. Сохранение с пересчетом периодов           │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

### Фоновые задачи

```
┌─────────────────────────────────────────────────────┐
│  asyncio.create_task(run_periodic_monitoring(24))   │
│  ┌───────────────────────────────────────────────┐  │
│  │ while True:                                   │  │
│  │   - Запросить iiko                            │  │
│  │   - Сравнить с БД                             │  │
│  │   - Обновить изменения                        │  │
│  │   - Спать 24 часа                             │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

## Пример сценария использования

### Сценарий 1: Автоматическое обнаружение изменения

```
День 1 (01.12.2024):
├─ Мониторинг запускается
├─ iiko: Иванов = Официант
└─ БД: [01.12.2024 - NULL: Официант]

День 15 (15.12.2024):
├─ Мониторинг запускается
├─ iiko: Иванов = Старший официант
├─ БД изменилась:
│  ├─ [01.12.2024 - 14.12.2024: Официант]
│  └─ [15.12.2024 - NULL: Старший официант]
└─ Лог: 🔄 Изменение должности: Иванов (Официант → Старший официант)
```

### Сценарий 2: Ручная корректировка прошлого

```
Текущая дата: 20.12.2024
БД (до корректировки):
└─ [01.12.2024 - NULL: Официант]

Действия:
1. Админ: /correct_position
2. Выбор: Иванов
3. Дата: 10.12.2024
4. Должность: Старший официант

БД (после корректировки):
├─ [01.12.2024 - 09.12.2024: Официант]
└─ [10.12.2024 - NULL: Старший официант]
```

### Сценарий 3: Расчет зарплаты с изменением должности

```
Период расчета: 01.12.2024 - 31.12.2024

История должностей:
├─ [01.12 - 09.12]: Официант (почасовая 300₽/ч, 1%)
└─ [10.12 - 31.12]: Старший официант (посменная 5000₽, 1.5%)

Attendance:
├─ 01.12 - 09.12: 72 часа (9 смен)
└─ 10.12 - 31.12: 176 часов (22 смены)

Расчет:
Период 1 (Официант):
  Часы: 72 × 300₽ = 21,600₽
  Выручка: 400,000₽ × 1% = 4,000₽
  Итого: 25,600₽

Период 2 (Старший официант):
  Смены: 22 × 5,000₽ = 110,000₽
  Выручка: 1,200,000₽ × 1.5% = 18,000₽
  Итого: 128,000₽

ИТОГО: 153,600₽
```

## Алгоритм пересчета периодов

### Визуализация `set_employee_position(emp_id, position, date)`

```
Исходное состояние:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
│         Официант          │      Повар       │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
01.12              15.12              31.12

Установка "Старший официант" с 10.12:

Шаг 1: Найти пересечение
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
│         Официант          │      Повар       │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                  ↑
                 10.12 (новая дата)

Шаг 2: Обрезать пересекающийся период
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
│  Официант  │                   Повар       │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
01.12    09.12              15.12        31.12

Шаг 3: Удалить полностью перекрытые периоды (Повар удален)

Шаг 4: Добавить новый период
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
│  Официант  │ Старший официант             │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
01.12    09.12  10.12                   NULL
```

## Зависимости модулей

```
main.py
  ├─→ db/employee_position_history_db.py (init)
  ├─→ services/position_monitor.py (background task)
  └─→ bot.py
        └─→ handlers/correct_position.py

handlers/salary.py
  └─→ services/salary_from_iiko.py
        ├─→ db/employee_position_history_db.py (query history)
        └─→ db/position_commission_db.py (get settings)

services/position_monitor.py
  └─→ db/employee_position_history_db.py (update positions)
```

## Состояния FSM (correct_position handler)

```
START
  │
  ↓
[selecting_employee] ─→ Выбор сотрудника
  │
  ↓
[entering_date] ─→ Ввод даты (DD.MM.YYYY)
  │
  ↓
[selecting_position] ─→ Выбор должности
  │
  ↓
SAVE ─→ Пересчет периодов ─→ END
```

## Производительность

### Оптимизации:
1. **Кэширование должностей**: Справочник roles загружается один раз при расчете
2. **Batch обработка**: Все сотрудники обрабатываются за один запрос к iiko
3. **Индексы БД**: 
   - `employee_id, valid_from` - быстрый поиск текущей должности
   - `employee_id, valid_to` - быстрый поиск последней записи
4. **Ленивая загрузка истории**: История запрашивается только при расчете зарплаты

### Масштабируемость:
- 100 сотрудников: ~2-3 сек на полный расчет
- 1000 сотрудников: ~20-30 сек на полный расчет
- Мониторинг: ~5-10 сек раз в сутки
